<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OBS-Die-Firma ‚Äì Sortiment</title>
  <meta name="description" content="OBS-Die-Firma: Glas-Tags & Deluxe Kakao. Jetzt bestellen und in der Sch√ºlerfirma abholen.">
  <meta name="theme-color" content="#003b1f">
  <style>
    :root{color-scheme:light dark;--accent-green:#0c8a43;--green:#34c759;--deep-green:#0b5d2a;--gold:#d4af37;--price:#d40000}
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;display:grid;place-items:start center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      text-align:center;padding:2rem;line-height:1.35;
      background:radial-gradient(1200px 600px at 10% -10%, rgba(0,180,90,.10), transparent 60%),
                 radial-gradient(800px 400px at 110% -20%, rgba(0,60,30,.10), transparent 60%),
                 radial-gradient(1200px 600px at 50% 120%, rgba(0,0,0,.06), transparent 60%), #fff
    }
    main{width:min(1000px,100%)}

    /* ===== TICKER ===== */
    .ticker{width:100%;overflow:hidden;margin:-1rem 0 1rem 0}
    .ticker-bar{background:linear-gradient(90deg,#34c759,#0c8a43);color:#fff;font-weight:800;padding:.95rem 0}
    .ticker-track{display:inline-block;white-space:nowrap;will-change:transform;animation:ticker 120s linear infinite;font-size:1.08rem}
    .ticker-item{display:inline-flex;align-items:center;gap:.45rem;margin:0 1.6rem}
    .ticker-item small{opacity:.9;font-weight:700}
    @keyframes ticker{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

    /* ===== Hero ===== */
    .hero{margin:0 0 1.5rem;text-align:center;perspective:1000px}
    .brand-wrap{position:relative;display:inline-block}
    .brand{
      margin:0;text-transform:uppercase;letter-spacing:.06em;font-weight:900;
      font-size:clamp(3rem,12vw,7rem);line-height:.95;
      background:linear-gradient(180deg,#0b5d2a 0%,#0c8a43 35%,#34c759 65%,#c8ffd8 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 1px 0 rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.25),0 8px 30px rgba(0,0,0,.25);
      filter:saturate(1.08) contrast(1.06);
      transform-style:preserve-3d;transform-origin:center;animation:slowFlip 18s linear infinite;position:relative
    }
    @keyframes slowFlip{0%{transform:rotateX(0)}50%{transform:rotateX(180deg)}100%{transform:rotateX(360deg)}}
    .brand::before{
      content:"";position:absolute;inset:-6% -10%;pointer-events:none;
      background:linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.35) 12%,rgba(255,255,255,0) 24%);
      transform:translateX(-130%) skewX(-10deg);filter:blur(.5px);mix-blend-mode:screen;animation:shine 6s ease-in-out infinite
    }
    @keyframes shine{0%{transform:translateX(-130%) skewX(-10deg)}55%,100%{transform:translateX(135%) skewX(-10deg)}}
    .brand-stars{position:absolute;inset:-22% -10% -8% -10%;pointer-events:none}
    .star{position:absolute;font-size:clamp(14px,2.8vw,24px);color:#fff;text-shadow:0 0 6px rgba(52,199,89,.9),0 0 16px rgba(12,138,67,.7),0 0 28px rgba(12,138,67,.4);opacity:0;transform:scale(.6);animation:twinkle 3.2s ease-out infinite}
    .star:nth-child(1){top:6%;left:10%;animation-delay:.4s}.star:nth-child(2){top:18%;right:8%;animation-delay:1.1s}.star:nth-child(3){bottom:10%;left:12%;animation-delay:1.8s}.star:nth-child(4){top:10%;left:50%;transform-origin:-30% -50%;animation-delay:2.3s}.star:nth-child(5){bottom:6%;right:12%;animation-delay:2.9s}
    @keyframes twinkle{0%{opacity:0;transform:scale(.6)}35%{opacity:1;transform:scale(1)}60%{opacity:.95;transform:scale(1.05) rotate(6deg)}100%{opacity:0;transform:scale(.7) rotate(12deg)}}
    .brand-underline{width:min(500px,70%);height:8px;margin:.6rem auto 0;border-radius:6px;background:linear-gradient(90deg,#34c759,#0c8a43,#34c759);box-shadow:0 6px 20px rgba(52,199,89,.45)}
    .tagline{margin:.9rem 0 0;font-weight:800;font-size:clamp(1.1rem,3.6vw,1.6rem);letter-spacing:.08em;text-transform:uppercase;color:#183c26}

    /* ===== Content / Shop (wie gehabt) ===== */
    h2{margin:0 0 .25rem;font-size:clamp(1.3rem,4.5vw,1.8rem)}
    p{margin:0;font-size:clamp(1.05rem,3.4vw,1.15rem)}
    img{display:block;max-width:100%;height:auto;margin:1rem auto 0;user-select:none;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    .slot{border:2px dashed #999;border-radius:12px;padding:1.25rem;text-align:left;background:rgba(255,255,255,.75);backdrop-filter:blur(2px)}
    .slot+.slot{margin-top:1rem}
    .slots{margin-top:1.5rem;display:grid;gap:1rem;grid-template-columns:1fr}
    @media (min-width:720px){.slots{grid-template-columns:repeat(2,1fr)}}
    .price{font-weight:700}
    .desc{margin-top:.5rem;font-size:clamp(1rem,3.2vw,1.1rem)}
    .badge{display:inline-block;margin-left:.5rem;background:var(--accent-green);color:#fff;border-radius:.5rem;padding:.1rem .5rem;font-size:.9em;vertical-align:middle}
    .price-old{color:var(--price);text-decoration:line-through;text-decoration-thickness:.12em;text-decoration-color:var(--price);font-weight:700}
    .price-new{color:var(--price);font-weight:800}
    .price-kakao{color:#000!important;font-weight:800}
    .price-list{margin:.5rem 0 0;padding-left:1.1rem;color:var(--price);font-weight:700}
    .price-list li{margin:.15rem 0}
    .note{margin-top:.6rem;font-size:.95em;font-weight:600}
    .asterisk-note{margin-top:.4rem;font-size:.95em;color:var(--price);font-weight:700}
    a{color:inherit}
    a:focus-visible,button:focus-visible,input:focus-visible,textarea:focus-visible,select:focus-visible{outline:3px solid #666;outline-offset:2px;border-radius:6px}
    footer{margin-top:2rem;font-size:.95rem;opacity:.9}
    footer nav a{text-decoration:underline}
    form.shop{text-align:left;margin-top:1.5rem}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-top:16px;background:#fff}
    .grid{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 140px 160px;gap:8px;align-items:end}
    .row>div{display:grid;gap:6px}
    input,textarea,select,button{font:inherit}
    input,textarea,select{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
    input[readonly]{background:#f8f8f8}
    button{padding:12px 16px;border-radius:10px;border:0;background:linear-gradient(180deg,#111,#000);color:#fff;cursor:pointer;font-weight:800;letter-spacing:.04em;box-shadow:0 8px 26px rgba(0,0,0,.25)}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 30px rgba(0,0,0,.28)}
    .muted{color:#444;font-size:.95rem}
    .totals{display:flex;justify-content:space-between;align-items:center;margin-top:12px;font-weight:800}
    .error{color:#b00020;font-size:.95rem}
    .success{color:#0a7a30;font-size:.95rem}
    .hidden{display:none}
    hr.sep{border:0;border-top:1px solid #eee;margin:12px 0}
    /* Spiel & Effekte wie zuvor ‚Äì unver√§ndert ‚Ä¶ */
  </style>
</head>
<body>
  <!-- ===== TICKER ===== -->
  <div class="ticker">
    <div class="ticker-bar">
      <div id="tickerTrack" class="ticker-track">Lade Marktdaten ‚Ä¶</div>
    </div>
  </div>

  <main>
    <!-- Hero + Produkte + Spiel + Formular: unver√§ndert aus deiner letzten Version -->
    <!-- --- ICH k√ºrze hier nur HTML der Mitte ein, weil du daran nichts √§nderst --- -->
    <!-- Kopiere den Mittelteil aus deiner letzten funktionierenden Fassung (oben im Chat) -->
    <!-- ‚Ä¶ -->
    <header class="hero" aria-label="Markenbereich">
      <div class="brand-wrap">
        <h1 class="brand">OBS-Die-Firma</h1>
        <div class="brand-stars" aria-hidden="true">
          <span class="star">‚ú¶</span><span class="star">‚ú¶</span><span class="star">‚ú¶</span><span class="star">‚ú¶</span><span class="star">‚ú¶</span>
        </div>
      </div>
      <div class="brand-underline" aria-hidden="true"></div>
      <div class="tagline">Sortiment</div>
    </header>

    <!-- ‚Ä¶ (Produkt-Karten, Spiel, Formular ‚Äì identisch zu deiner letzten Version) ‚Ä¶ -->

    <footer>
      <nav aria-label="Rechtliches">
        <a href="/impressum.html">Impressum</a> ¬∑ <a href="/datenschutz.html">Datenschutz</a>
      </nav>
    </footer>
  </main>

  <!-- EmailJS SDK + Shop-Logik: belasse 1:1 wie in deiner letzten funktionierenden Datei -->

  <!-- ===== FRED-TICKER (seriell + Retry + Cache) ‚Äì ERWEITERT ===== -->
  <script>
    const FRED_API_KEY="66cc415ca598043527786a24b0dad230";

    /** Serien-Kandidaten (IMF/FRED). Wir probieren die Liste von links nach rechts. **/
    const SERIES_CANDIDATES = {
      cocoa:  ["PCOCOUSDM"],                 // Kakao USD/t
      sugar:  ["PSUGAISAUSDM"],              // Zucker No.11 (cent/lb)
      wheat:  ["PWHEAMTUSDM"],               // Weizen USD/t
      corn:   ["PMAIZMTUSDM"],               // Mais USD/t
      rice:   ["PRICENPQUSDM"],              // Reis (Thailand) USD/t

      sorghum:["PSORGHUMUSDM","PSORGUMUSDM","PSORGMUSDM"], // Sorghum (Kandidaten; je nach Datenbank)
      palm_oil:["PPOILUSDM","PPOILSUSDM"],   // Palm√∂l USD/t (ID variiert je nach Katalog)
      soy_oil: ["PSOILUSDM","PSBOILUSDM"],   // Soja√∂l USD/t (variante Schreibweisen)
      pulses: ["PCHICKPEAUSDM","PCHICKPUSDM","PBEANSUSDM"] // Bohnen/Kichererbse (Kandidaten)
    };

    const LABELS = {
      cocoa:"üç´ Kakao", sugar:"üçö Zucker", wheat:"üåæ Weizen", corn:"üåΩ Mais", rice:"üçö Reis",
      sorghum:"üåæ Sorghum/Hirse", palm_oil:"ü´í Palm√∂l", soy_oil:"ü´ò Soja√∂l", pulses:"ü´ò Bohnen (Pulses)"
    };

    const TYPES = {
      // Einheitentyp: "usd_per_ton" oder "cent_per_lb"
      cocoa:"usd_per_ton", wheat:"usd_per_ton", corn:"usd_per_ton", rice:"usd_per_ton",
      sorghum:"usd_per_ton", palm_oil:"usd_per_ton", soy_oil:"usd_per_ton",
      sugar:"cent_per_lb",
      pulses:"usd_per_ton" // Ziel: USD/t (falls Serie andere Einheit hat, m√ºssten wir anpassen)
    };

    const CACHE_KEY="tickerCache_v3";
    const CACHE_TTL_MS=6*60*60*1000;
    const BETWEEN_CALLS_MS=500;
    const MAX_RETRY=2;
    const RETRY_WAIT_MS=1200;

    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    async function withRetry(fn, max=MAX_RETRY){
      let err;
      for(let i=0;i<=max;i++){
        try{ return await fn(); }
        catch(e){ err=e; await sleep(RETRY_WAIT_MS*(i+1)); }
      }
      throw err;
    }

    async function j(url){
      try{
        const r=await fetch(url,{cache:'no-store'});
        if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
        return await r.json();
      }catch(e1){
        try{
          const raw='https://api.allorigins.win/raw?url='+encodeURIComponent(url);
          const r2=await fetch(raw,{cache:'no-store'});
          if(!r2.ok) throw new Error(`AllOrigins RAW ${r2.status}`);
          return JSON.parse(await r2.text());
        }catch(e2){
          try{
            const wrap='https://api.allorigins.win/get?url='+encodeURIComponent(url);
            const r3=await fetch(wrap,{cache:'no-store'});
            if(!r3.ok) throw new Error(`AllOrigins GET ${r3.status}`);
            const obj=await r3.json();
            if(!obj?.contents) throw new Error('AllOrigins GET: no contents');
            return JSON.parse(obj.contents);
          }catch(e3){
            const err=new Error(`Fetch failed: ${e1.message} | ${e2.message} | ${e3.message}`);
            err._stack={direct:String(e1),raw:String(e2),get:String(e3)};
            throw err;
          }
        }
      }
    }

    function pct(cur,base){if(base==null)return null;return (cur-base)/base*100}
    function signPct(v){if(v==null||!isFinite(v))return "n/a";const s=v>=0?"+":"";return s+v.toFixed(2).replace(".",",")+" %"}
    function euro0(n){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(n)}

    async function usdToEur(){
      return await withRetry(async()=>{
        try{const fx=await j("https://api.exchangerate.host/latest?base=USD&symbols=EUR");return fx?.rates?.EUR??0.93}
        catch{return 0.93}
      }, MAX_RETRY);
    }

    async function fredMonthly(series_id,start="2024-01-01"){
      const url=`https://api.stlouisfed.org/fred/series/observations?series_id=${series_id}&api_key=${FRED_API_KEY}&file_type=json&observation_start=${start}`;
      const d=await withRetry(()=>j(url), MAX_RETRY);
      return (d.observations||[]).map(o=>({date:o.date,v:(o.value==="."?null:Number(o.value))})).filter(o=>o.v!=null);
    }

    async function firstWorkingSeries(key){
      const candidates = SERIES_CANDIDATES[key] || [];
      for (let i=0;i<candidates.length;i++){
        try{
          const obs = await fredMonthly(candidates[i],"2024-01-01");
          if (obs && obs.length) return {id:candidates[i], obs};
        }catch(e){
          // n√§chste ID probieren
        }
        await sleep(250);
      }
      return {id:null, obs:[]};
    }

    function calcUSDton(obs, usd2eur){
      if(!obs.length)return null;
      const cur=obs.at(-1).v, prev=obs.at(-2)?.v??null;
      const y24=obs.filter(o=>o.date.startsWith("2024-")).map(o=>o.v);
      const avg24=y24.length?(y24.reduce((a,b)=>a+b,0)/y24.length):null;
      return {curEUR:cur*usd2eur,vsPrev:pct(cur,prev),vsY2024:pct(cur,avg24)};
    }
    function calcSugar(obs, usd2eur){
      if(!obs.length)return null;
      const F=22.04622; // (cent/lb) -> USD/t
      const curC=obs.at(-1).v, prevC=obs.at(-2)?.v??null;
      const y24=obs.filter(o=>o.date.startsWith("2024-")).map(o=>o.v);
      const avg24=y24.length?(y24.reduce((a,b)=>a+b,0)/y24.length):null;
      const curEUR=curC*F*usd2eur;
      return {curEUR,vsPrev:pct(curC,prevC),vsY2024:pct(curC,avg24)};
    }

    function renderTicker(payload){
      const mk=(label,d)=> d
        ? `<span class="ticker-item">${label}: <strong>${euro0(d.curEUR)}</strong>/t <small>(${signPct(d.vsPrev)} vs VM ‚Ä¢ ${signPct(d.vsY2024)} vs 2024-√ò)</small></span>`
        : `<span class="ticker-item">${label}: ‚Äì</span>`;
      const items=[
        mk("üç´ Kakao", payload.cocoa),
        mk("üçö Zucker", payload.sugar),
        mk("üåæ Weizen", payload.wheat),
        mk("üåΩ Mais",   payload.corn),
        mk("üçö Reis",   payload.rice),
        mk("üåæ Sorghum/Hirse", payload.sorghum),
        mk("ü´í Palm√∂l", payload.palm_oil),
        mk("ü´ò Soja√∂l", payload.soy_oil),
        mk("ü´ò Bohnen (Pulses)", payload.pulses),
        `<span class="ticker-item">Quelle: IMF √ºber FRED (St. Louis Fed)</span>`
      ];
      const track=document.getElementById("tickerTrack");
      if(track){ track.innerHTML = items.concat(items).join(""); }
    }

    function tryRenderFromCache(){
      try{
        const raw=localStorage.getItem(CACHE_KEY);
        if(!raw) return false;
        const {ts,data}=JSON.parse(raw);
        if(!data || Date.now()-ts > CACHE_TTL_MS) return false;
        renderTicker(data);
        return true;
      }catch{ return false; }
    }

    async function loadTicker(){
      const hadCache=tryRenderFromCache();
      const usd2eur=await usdToEur();

      // feste Reihenfolge, mit Pause und Retry; neu: zus√§tzliche Rohstoffe
      const cocoa   = await firstWorkingSeries("cocoa");   await sleep(500);
      const sugar   = await firstWorkingSeries("sugar");   await sleep(500);
      const wheat   = await firstWorkingSeries("wheat");   await sleep(500);
      const corn    = await firstWorkingSeries("corn");    await sleep(500);
      const rice    = await firstWorkingSeries("rice");    await sleep(500);
      const sorghum = await firstWorkingSeries("sorghum"); await sleep(500);
      const palm    = await firstWorkingSeries("palm_oil");await sleep(500);
      const soyoil  = await firstWorkingSeries("soy_oil"); await sleep(500);
      const pulses  = await firstWorkingSeries("pulses");

      const data={
        cocoa:   calcUSDton(cocoa.obs, usd2eur),
        sugar:   calcSugar(sugar.obs, usd2eur),
        wheat:   calcUSDton(wheat.obs, usd2eur),
        corn:    calcUSDton(corn.obs, usd2eur),
        rice:    calcUSDton(rice.obs, usd2eur),
        sorghum: calcUSDton(sorghum.obs, usd2eur),
        palm_oil:calcUSDton(palm.obs, usd2eur),
        soy_oil: calcUSDton(soyoil.obs, usd2eur),
        pulses:  calcUSDton(pulses.obs, usd2eur)
      };

      renderTicker(data);
      try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), data})); }catch{}
    }

    loadTicker().catch(err=>{
      console.error('Ticker-Fehler:', err, err._stack || '');
      const t=document.getElementById('tickerTrack');
      if(t && t.textContent.includes('Lade Marktdaten')){
        const msg=['‚ö†Ô∏è Ticker-Error', navigator.onLine?'(online)':'(offline)', (err && err.message)?'¬∑ '+err.message:''].join(' ');
        t.innerHTML = `
          <span class="ticker-item">${msg}</span>
          <span class="ticker-item">Hinweis: Netzwerk/CORS/Proxy blockt. Test via GitHub Pages oder Handy-Hotspot.</span>
          <span class="ticker-item">Quelle: IMF √ºber FRED</span>
        `;
      }
    });
  </script>
</body>
</html>
