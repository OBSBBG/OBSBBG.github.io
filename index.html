<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OBS-Die-Firma – Sortiment</title>
  <meta name="description" content="OBS-Die-Firma: Glas-Tags & Deluxe Kakao. Jetzt bestellen und in der Schülerfirma abholen.">
  <meta name="theme-color" content="#003b1f">
  <style>
    :root{color-scheme:light dark;--accent-green:#0c8a43;--green:#34c759;--deep-green:#0b5d2a;--gold:#d4af37;--price:#d40000}
    *{box-sizing:border-box}
    html,body{overscroll-behavior-y:contain}
    body{
      margin:0;min-height:100vh;display:grid;place-items:start center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      text-align:center;padding:2rem;line-height:1.35;
      background:radial-gradient(1200px 600px at 10% -10%, rgba(0,180,90,.10), transparent 60%),
                 radial-gradient(800px 400px at 110% -20%, rgba(0,60,30,.10), transparent 60%),
                 radial-gradient(1200px 600px at 50% 120%, rgba(0,0,0,.06), transparent 60%), #fff
    }
    main{width:min(1000px,100%)}

    /* ===== TICKER ===== */
    .ticker{width:100%;overflow:hidden;margin:-1rem 0 1rem 0}
    .ticker-bar{background:linear-gradient(90deg,#34c759,#0c8a43);color:#fff;font-weight:800;padding:.95rem 0}
    .ticker-track{display:inline-block;white-space:nowrap;will-change:transform;animation:ticker 120s linear infinite;font-size:1.08rem}
    .ticker-item{display:inline-flex;align-items:center;gap:.45rem;margin:0 1.6rem}
    .ticker-item small{opacity:.9;font-weight:700}
    @keyframes ticker{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

    /* ===== Hero ===== */
    .hero{margin:0 0 1.5rem;text-align:center;perspective:1000px}
    .brand-wrap{position:relative;display:inline-block}
    .brand{
      margin:0;text-transform:uppercase;letter-spacing:.06em;font-weight:900;
      font-size:clamp(3rem,12vw,7rem);line-height:.95;
      background:linear-gradient(180deg,#0b5d2a 0%,#0c8a43 35%,#34c759 65%,#c8ffd8 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 1px 0 rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.25),0 8px 30px rgba(0,0,0,.25);
      filter:saturate(1.08) contrast(1.06);
      transform-style:preserve-3d;transform-origin:center;animation:slowFlip 18s linear infinite;position:relative
    }
    @keyframes slowFlip{0%{transform:rotateX(0)}50%{transform:rotateX(180deg)}100%{transform:rotateX(360deg)}}
    .brand::before{
      content:"";position:absolute;inset:-6% -10%;pointer-events:none;
      background:linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.35) 12%,rgba(255,255,255,0) 24%);
      transform:translateX(-130%) skewX(-10deg);filter:blur(.5px);mix-blend-mode:screen;animation:shine 6s ease-in-out infinite
    }
    @keyframes shine{0%{transform:translateX(-130%) skewX(-10deg)}55%,100%{transform:translateX(135%) skewX(-10deg)}}
    .brand-stars{position:absolute;inset:-22% -10% -8% -10%;pointer-events:none}
    .star{position:absolute;font-size:clamp(14px,2.8vw,24px);color:#fff;text-shadow:0 0 6px rgba(52,199,89,.9),0 0 16px rgba(12,138,67,.7),0 0 28px rgba(12,138,67,.4);opacity:0;transform:scale(.6);animation:twinkle 3.2s ease-out infinite}
    .star:nth-child(1){top:6%;left:10%;animation-delay:.4s}.star:nth-child(2){top:18%;right:8%;animation-delay:1.1s}.star:nth-child(3){bottom:10%;left:12%;animation-delay:1.8s}.star:nth-child(4){top:10%;left:50%;transform-origin:-30% -50%;animation-delay:2.3s}.star:nth-child(5){bottom:6%;right:12%;animation-delay:2.9s}
    @keyframes twinkle{0%{opacity:0;transform:scale(.6)}35%{opacity:1;transform:scale(1)}60%{opacity:.95;transform:scale(1.05) rotate(6deg)}100%{opacity:0;transform:scale(.7) rotate(12deg)}}
    .brand-underline{width:min(500px,70%);height:8px;margin:.6rem auto 0;border-radius:6px;background:linear-gradient(90deg,#34c759,#0c8a43,#34c759);box-shadow:0 6px 20px rgba(52,199,89,.45)}
    .tagline{margin:.9rem 0 0;font-weight:800;font-size:clamp(1.1rem,3.6vw,1.6rem);letter-spacing:.08em;text-transform:uppercase;color:#183c26}

    /* ===== Content ===== */
    h2{margin:0 0 .25rem;font-size:clamp(1.3rem,4.5vw,1.8rem)}
    p{margin:0;font-size:clamp(1.05rem,3.4vw,1.15rem)}
    img{display:block;max-width:100%;height:auto;margin:1rem auto 0;user-select:none;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    .slot{border:2px dashed #999;border-radius:12px;padding:1.25rem;text-align:left;background:rgba(255,255,255,.75);backdrop-filter:blur(2px)}
    .slot+.slot{margin-top:1rem}
    .slots{margin-top:1.5rem;display:grid;gap:1rem;grid-template-columns:1fr}
    @media (min-width:720px){.slots{grid-template-columns:repeat(2,1fr)}}
    .price{font-weight:700}
    .desc{margin-top:.5rem;font-size:clamp(1rem,3.2vw,1.1rem)}
    .badge{display:inline-block;margin-left:.5rem;background:var(--accent-green);color:#fff;border-radius:.5rem;padding:.1rem .5rem;font-size:.9em;vertical-align:middle}

    /* Preisfarben */
    .price-old{color:var(--price);text-decoration:line-through;text-decoration-thickness:.12em;text-decoration-color:var(--price);font-weight:700}
    .price-new{color:var(--price);font-weight:800}
    .price-kakao{color:#000!important;font-weight:800}
    .price-list{margin:.5rem 0 0;padding-left:1.1rem;color:var(--price);font-weight:700}
    .price-list li{margin:.15rem 0}
    .note{margin-top:.6rem;font-size:.95em;font-weight:600}
    .asterisk-note{margin-top:.4rem;font-size:.95em;color:var(--price);font-weight:700}
    a{color:inherit}
    a:focus-visible,button:focus-visible,input:focus-visible,textarea:focus-visible,select:focus-visible{outline:3px solid #666;outline-offset:2px;border-radius:6px}
    footer{margin-top:2rem;font-size:.95rem;opacity:.9}
    footer nav a{text-decoration:underline}

    /* ===== Formular / Warenkorb ===== */
    form.shop{text-align:left;margin-top:1.5rem}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-top:16px;background:#fff}
    .grid{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 140px 160px;gap:8px;align-items:end}
    .row>div{display:grid;gap:6px}
    input,textarea,select,button{font:inherit}
    input,textarea,select{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
    input[readonly]{background:#f8f8f8}
    button{padding:12px 16px;border-radius:10px;border:0;background:linear-gradient(180deg,#111,#000);color:#fff;cursor:pointer;font-weight:800;letter-spacing:.04em;box-shadow:0 8px 26px rgba(0,0,0,.25)}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 30px rgba(0,0,0,.28)}
    .muted{color:#444;font-size:.95rem}
    .totals{display:flex;justify-content:space-between;align-items:center;margin-top:12px;font-weight:800}
    .error{color:#b00020;font-size:.95rem}
    .success{color:#0a7a30;font-size:.95rem}
    .hidden{display:none}
    hr.sep{border:0;border-top:1px solid #eee;margin:12px 0}

    /* ===== Werbeaktion Spiel ===== */
    .game-grid{display:grid;grid-template-columns:repeat(3,90px);grid-gap:10px;justify-content:center;margin-top:12px;touch-action:manipulation}
    .tile{
      width:90px;height:90px;border-radius:12px;border:1px solid #ccc;background:#efefef;
      cursor:pointer;position:relative;overflow:hidden;transition:transform .08s ease-in;
      display:grid;place-items:center;
      -webkit-tap-highlight-color:transparent;
      -webkit-user-select:none;user-select:none;
      touch-action:manipulation;
      outline:none;
    }
    .tile:active{transform:scale(.98)}
    .tile:focus{outline:none}
    .cover{position:absolute;inset:0;background:linear-gradient(180deg,#fafafa,#e9e9e9);pointer-events:none}
    .revealed{border-color:#999}
    .game-controls{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:10px;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f6f6f6;border:1px solid #e5e5e5;font-weight:600}
    .win{color:#0a7a30;font-weight:800}
    .lose{color:#b00020;font-weight:800}

    /* Glas-SVG */
    .glass{width:72px;height:72px;display:block}

    /* ===== Gewinn-Effekte Overlay ===== */
    .fx-layer{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9999}
    .obs-logo-fx{position:fixed;left:50%;top:-22vh;transform:translateX(-50%);font-weight:900;text-transform:uppercase;letter-spacing:.06em;font-size:min(20vw,180px);background:linear-gradient(180deg,var(--deep-green),var(--green));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 6px 26px rgba(0,0,0,.45);filter:drop-shadow(0 10px 30px rgba(0,0,0,.45));animation:fx-drop 1200ms cubic-bezier(.2,.8,.2,1) forwards,fx-pulse 1800ms ease-in-out 1200ms 3,fx-explode 700ms ease-out 6600ms forwards}
    @keyframes fx-drop{0%{top:-22vh;transform:translateX(-50%) scale(.88)}100%{top:40vh;transform:translateX(-50%) scale(1)}}
    @keyframes fx-pulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.12)}}
    @keyframes fx-explode{to{transform:translateX(-50%) scale(3.6);opacity:0}}
    .flash{position:fixed;inset:0;opacity:0;pointer-events:none;z-index:9998;mix-blend-mode:screen}
    .flash.green{background:radial-gradient(ellipse at center,rgba(12,138,67,.88),rgba(12,138,67,0) 62%);animation:flash-pop 420ms ease-out 6600ms both}
    .flash.gold{background:radial-gradient(ellipse at center,rgba(212,175,55,.88),rgba(212,175,55,0) 62%);animation:flash-pop 420ms ease-out 6800ms both}
    @keyframes flash-pop{from{opacity:0}45%{opacity:1}to{opacity:0}}
    .star-fx{position:fixed;font-weight:900;text-shadow:0 0 14px rgba(0,0,0,.28),0 0 24px currentColor,0 0 46px currentColor;filter:drop-shadow(0 0 10px currentColor) drop-shadow(0 0 18px currentColor);opacity:0;transform:scale(.85);animation:star-fade var(--dur,4.8s) ease-out var(--delay,0s) forwards;z-index:9997}
    @keyframes star-fade{0%{opacity:0;transform:scale(.85) translateY(0)}12%{opacity:1;transform:scale(1.05) translateY(-8px)}78%{opacity:.95}100%{opacity:0;transform:scale(1.18) translateY(-22px)}}
    .disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <!-- ===== TICKER ===== -->
  <div class="ticker">
    <div class="ticker-bar">
      <div id="tickerTrack" class="ticker-track">Lade Neuigkeiten …</div>
    </div>
  </div>

  <main>
    <header class="hero" aria-label="Markenbereich">
      <div class="brand-wrap">
        <h1 class="brand">OBS-Die-Firma</h1>
        <div class="brand-stars" aria-hidden="true">
          <span class="star">✦</span><span class="star">✦</span><span class="star">✦</span><span class="star">✦</span><span class="star">✦</span>
        </div>
      </div>
      <div class="brand-underline" aria-hidden="true"></div>
      <div class="tagline">Sortiment</div>
    </header>

    <!-- Produkt 1 -->
    <article class="slot">
      <h2>#1 Personalisierter Glas-Tag <span class="badge" aria-label="Sonderaktion">*</span></h2>
      <p class="desc">Vorher: <span class="price-old">3 €</span></p>
      <ul class="price-list" aria-label="Aktionspreise">
        <li>Einzelpreis: <span class="price-new">1,50 €</span></li>
        <li>Fünferpack: <span class="price-new">4,95 €</span></li>
        <li>Zehnerpack: <span class="price-new">9,95 €</span></li>
      </ul>
      <p id="deal-note" class="asterisk-note">* Sonderaktion: gültig solange der Vorrat reicht.</p>
      <p class="desc" style="margin-top:.6rem">Der sinnvolle Helfer, wo sich Leute zur Geselligkeit treffen. Nachhaltig, wiederverwendbar und gut für die Umwelt.</p>
      <p class="note">Wichtig: Bitte bei <strong>jeder Bestellung</strong> die <strong>Namen</strong> angeben, die auf die Glas-Tags sollen.</p>
      <ul class="price-list" aria-label="Material & Pflege Glas-Tags" style="margin-top:.6rem;color:inherit;font-weight:700">
        <li style="color:inherit">Material: PLA, PETG</li>
        <li style="color:inherit">Reinigung: nur feucht abwischen (nicht spülmaschinengeeignet)</li>
        <li style="color:inherit">Passform: passend auf alle von uns getesteten Gläser; leicht flexibel, fester Sitz</li>
      </ul>
      <img src="Tag.jpeg" alt="Personalisierter Glas-Tag mit Gravur" width="900" height="600" loading="eager" fetchpriority="high" decoding="async">
    </article>

    <section class="slots" aria-label="Weitere Produkte">
      <article class="slot">
        <h2>#2 Deluxe Kakao „All inclusive“ <span class="price">· <span class="price-kakao">5 €</span></span></h2>
        <p class="desc">Kugeln mit heißer Milch übergießen – fertig ist der Winter-Schoko-Traum.</p>
        <p class="desc" style="margin-top:.5rem"><strong>Inhaltsstoffe:</strong> Kuvertüre, Kakaopulver, Mini-Marshmallows (Supermarktqualität).</p>
        <img src="Tag2.jpeg" alt="Deluxe Kakao im Glas mit Schokoladen-Toppings" width="900" height="600" loading="lazy" decoding="async">
      </article>

      <article class="slot">
        <h2>#3 – bald verfügbar</h2>
        <p class="desc">Trag dich per E-Mail ein, wir informieren dich, sobald #3 da ist.</p>
      </article>
    </section>

    <!-- ========= Werbeaktion: Spiel ========= -->
    <section class="card" aria-labelledby="promoTitle">
      <h2 id="promoTitle">Werbeaktion: Gewinne einen Glas-Tag</h2>
      <p class="desc">Decke in 5 Versuchen <strong>drei gleiche</strong> Gläser im 3×3-Feld auf. Gewinnst du, bekommst du einen <strong>Glas-Tag gratis</strong> zu deiner Bestellung.</p>
      <div class="game-controls">
        <button type="button" id="startGameBtn">Spiel starten</button>
        <button type="button" id="newGameBtn" class="hidden">Neues Spiel</button>
        <span class="pill">Versuche übrig: <span id="triesLeft">–</span></span>
        <span class="pill">Treffer gleichfarbig: <span id="matchCount">0</span></span>
        <span class="pill hidden" id="cooldownPill">Nächstes Spiel in <span id="cooldownSec">0</span>s</span>
      </div>
      <div id="gameGrid" class="game-grid" aria-label="3x3 Spielfeld"></div>
      <div id="gameMsg" class="desc" style="margin-top:8px;"></div>
    </section>

    <!-- ========= Shop-Formular / Warenkorb ========= -->
    <form id="orderForm" class="shop" novalidate>
      <input type="text" id="hp_field" name="company" autocomplete="off" style="position:absolute;left:-9999px" tabindex="-1" aria-hidden="true">

      <div class="card">
        <h2>Kundendaten</h2>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px">
          <div><label for="name">Name*</label><input id="name" name="name" required></div>
          <div><label for="phone">Telefon*</label><input id="phone" name="phone" required></div>
          <div style="grid-column:1 / -1"><label for="email">E-Mail*</label><input id="email" name="email" type="email" required></div>
          <div style="grid-column:1 / -1"><label for="coupon">Gewinncode (optional)</label><input id="coupon" name="coupon" placeholder="z. B. Shop"></div>
        </div>
      </div>

      <div class="card">
        <h2>Produkte</h2>
        <div class="row">
          <div>
            <label for="p1Pack">Produkt 1: Glas-Tag</label>
            <select id="p1Pack" name="p1Pack">
              <option value="single">Einzel (1,50 € / Stück)</option>
              <option value="pack5">5er-Pack (4,95 € / Packung)</option>
              <option value="pack10">10er-Pack (9,95 € / Packung)</option>
            </select>
            <div class="muted" id="p1PiecesHint">Aktuell: 0 Stück</div>
          </div>
          <div><label for="p1Qty">Anzahl Packungen</label><input id="p1Qty" name="p1Qty" type="number" min="0" value="0"></div>
          <div><label>Zwischensumme</label><input id="p1Subtotal" type="text" value="0,00 €" readonly></div>
        </div>

        <div id="p1NamesBlock" class="grid hidden">
          <label for="p1Names">Namen für die Glas-Tags (ein Name pro Zeile) *</label>
          <textarea id="p1Names" name="p1Names" rows="5" placeholder="z. B. Anna&#10;Ben&#10;Cem"></textarea>
          <div class="muted">Die Anzahl der Zeilen muss der <strong>Gesamt-Stückzahl</strong> entsprechen.</div>
          <div id="p1NamesError" class="error hidden">Anzahl der Namen passt nicht zur Stückzahl.</div>
        </div>

        <hr class="sep">

        <div class="row">
          <div>
            <label>Produkt 2: Deluxe Kakao</label>
            <div class="muted">Stückpreis: <span class="price-kakao" id="p2PriceLabel">5,00</span> €</div>
          </div>
          <div><label for="p2Qty">Menge</label><input id="p2Qty" name="p2Qty" type="number" min="0" value="0"></div>
          <div><label>Zwischensumme</label><input id="p2Subtotal" type="text" value="0,00 €" readonly></div>
        </div>

        <div class="totals"><div>Gesamt</div><div id="grandTotal">0,00 €</div></div>
      </div>

      <div class="card">
        <h2>Warenkorb</h2>
        <div id="cartPreview" class="muted">Noch keine Artikel.</div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr auto; gap:12px">
        <div class="muted">Nach dem Absenden erhältst du eine <strong>Bestätigungsmail</strong> mit dem <strong>Abholtermin</strong> in der Schülerfirma. <strong>Keine Lieferung.</strong></div>
        <button type="submit">Bestellung abschicken</button>
      </div>
      <div id="formError" class="error hidden" role="alert"></div>
      <div id="formOk" class="success hidden" role="status">Bestellung gesendet. Danke! Wir melden uns per E-Mail mit dem Abholtermin.</div>
    </form>

    <footer>
      <nav aria-label="Rechtliches">
        <a href="/impressum.html">Impressum</a> · <a href="/datenschutz.html">Datenschutz</a>
      </nav>
    </footer>
  </main>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    /* ===== EmailJS + Preise ===== */
    const EMAILJS_PUBLIC_KEY="xAOygDJhZcJrXGuSb";
    const EMAILJS_SERVICE_ID="service_l642tri";
    const EMAILJS_TEMPLATE_ID="template_ggtexbv";
    const PRICES={p1:{single:1.50,pack5:4.95,pack10:9.95},p1PiecesPer:{single:1,pack5:5,pack10:10},p2:5.00};
    (function(){emailjs.init(EMAILJS_PUBLIC_KEY)})();
    const el=(id)=>document.getElementById(id);
    const formatEUR=(n)=>n.toLocaleString('de-DE',{style:'currency',currency:'EUR'});
    const formatLines=(arr)=>arr.join(' | ');

    /* ===== Spiel ===== */
    const COLORS=["#e74c3c","#f39c12","#f1c40f","#2ecc71","#3498db","#9b59b6","#e67e22","#1abc9c","#e84393"];
    let board=[],revealed=new Set(),triesLeft=0,won=false;
    let gamesPlayed=0,startLocked=false,startCooldownTimer=null;
    let revealLock=false;

    function glassSVG(color){const c=color;return `<svg class="glass" viewBox="0 0 100 100" aria-hidden="true"><rect x="22" y="18" width="56" height="70" rx="10" ry="10" fill="url(#g1)" stroke="#d0d0d0" stroke-width="2"/><rect x="26" y="48" width="48" height="36" rx="8" ry="8" fill="${c}" opacity="0.9"/><rect x="26" y="22" width="8" height="52" rx="4" fill="#ffffff" opacity="0.35"/><g transform="translate(70,30)"><circle r="10" fill="#2d2d2d"/><circle r="3.2" cx="-3" cy="-3" fill="#d9d9d9"/></g><defs><linearGradient id="g1" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#fdfdfd"/><stop offset="1" stop-color="#efefef"/></linearGradient></defs></svg>`}
    function pickUnique(a,k){const c=a.slice().map(x=>({x,r:Math.random()})).sort((p,q)=>p.r-q.r).map(o=>o.x);return c.slice(0,k)}

    function newBoard(){
      if(startLocked)return;
      const seven=pickUnique(COLORS,7);
      const winColor=seven[Math.floor(Math.random()*seven.length)];
      const tiles=[];for(let i=0;i<3;i++)tiles.push(winColor);
      const others=seven.filter(c=>c!==winColor).slice(0,6);tiles.push(...others);
      board=tiles.map(c=>({c,r:Math.random()})).sort((a,b)=>a.r-b.r).map(o=>o.c);

      revealed.clear();triesLeft=5;won=false;
      el('triesLeft').textContent=String(triesLeft);
      el('matchCount').textContent="0";
      el('gameMsg').textContent="";
      renderBoard();

      el('startGameBtn').classList.add('hidden');
      el('newGameBtn').classList.remove('hidden');
      el('cooldownPill').classList.add('hidden');
    }

    function renderBoard(){
      const grid=el('gameGrid');grid.innerHTML="";
      board.forEach((color,i)=>{
        const tile=document.createElement('button');
        tile.type='button'; tile.className='tile';
        tile.dataset.index=String(i);
        tile.setAttribute('aria-label','verdeckt');
        tile.innerHTML = glassSVG(color);

        const cover=document.createElement('div');
        cover.className='cover'; cover.style.opacity='1';
        cover.style.transition='opacity .18s ease';
        tile.appendChild(cover);

        tile.addEventListener('pointerdown', (evt)=> onReveal(evt, tile), {passive:false});
        grid.appendChild(tile);
      });
    }

    function onReveal(e, tile){
      e.preventDefault(); e.stopPropagation();
      if (revealLock) return;
      const idx=Number(tile.dataset.index);
      if(won || triesLeft<=0 || revealed.has(idx)) return;

      revealLock=true; setTimeout(()=>{revealLock=false},180);

      revealed.add(idx);
      triesLeft--; el('triesLeft').textContent=String(triesLeft);

      tile.classList.add('revealed');
      const cover=tile.querySelector('.cover'); cover.style.opacity='0';

      const counts={}; revealed.forEach(i=>{ const c=board[i]; counts[c]=(counts[c]||0)+1; });
      const maxSame=Math.max(...Object.values(counts));
      el('matchCount').textContent=String(maxSame);

      if(maxSame>=3){
        won=true;
        el('gameMsg').innerHTML=`<span class="win">Gewonnen! 🎉 Du erhältst einen Glas-Tag gratis zu deiner Bestellung.</span>`;
        const couponEl=el('coupon'); if(couponEl && !couponEl.value.trim()){ couponEl.value='Shop'; recalc(); }
        winEffects(); endGameStartCooldown(); return;
      }

      if(triesLeft===0){
        el('gameMsg').innerHTML=`<span class="lose">Leider verloren. Versuch’s nochmal!</span>`;
        endGameStartCooldown();
      }
    }

    function endGameStartCooldown(){
      gamesPlayed += 1;
      const delaySec = gamesPlayed * 5;
      startLocked = delaySec > 0;

      const startBtn = el('startGameBtn');
      const newBtn   = el('newGameBtn');
      startBtn.classList.remove('hidden');
      newBtn.classList.add('hidden');

      if (!startLocked) return;

      startBtn.classList.add('disabled');
      const pill = el('cooldownPill');
      const out  = el('cooldownSec');
      pill.classList.remove('hidden');
      let remain = delaySec;
      out.textContent = String(remain);

      clearInterval(startCooldownTimer);
      startCooldownTimer = setInterval(()=>{
        remain -= 1;
        if (remain <= 0){
          clearInterval(startCooldownTimer);
          startLocked = false;
          pill.classList.add('hidden');
          startBtn.classList.remove('disabled');
        } else {
          out.textContent = String(remain);
        }
      }, 1000);
    }

    function winEffects(){
      const layer=document.createElement('div'); layer.className='fx-layer'; document.body.appendChild(layer);
      const logo=document.createElement('div'); logo.className='obs-logo-fx'; logo.textContent='OBS'; layer.appendChild(logo);
      const flashG=document.createElement('div'); flashG.className='flash green';
      const flashGold=document.createElement('div'); flashGold.className='flash gold';
      layer.appendChild(flashG); layer.appendChild(flashGold);

      const vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0);
      const vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0);
      const STAR_COUNT=160;
      for(let i=0;i<STAR_COUNT;i++){
        const s=document.createElement('span');
        s.className='star-fx';
        s.textContent=(Math.random()<0.65)?'✦':(Math.random()<0.5?'✸':'✪');
        const isGreen=Math.random()<0.58;
        s.style.color=isGreen?'var(--green)':'var(--gold)';
        const size=20+Math.random()*24;
        s.style.fontSize=size.toFixed(0)+'px';
        s.style.left=(Math.random()*vw)+'px';
        s.style.top =(Math.random()*vh)+'px';
        const delay=0.1+Math.random()*1.6;
        const dur  =3.8+Math.random()*3.2;
        s.style.setProperty('--delay',delay.toFixed(2)+'s');
        s.style.setProperty('--dur',dur.toFixed(2)+'s');
        layer.appendChild(s);
      }
      setTimeout(()=>{ layer.remove(); }, 9000);
    }

    el('startGameBtn').addEventListener('click', newBoard);
    el('newGameBtn').addEventListener('click', newBoard);

    /* ===== Warenkorb ===== */
    function recalc(){
      const pack=el('p1Pack').value;
      const p1Qty=Math.max(0,parseInt(el('p1Qty').value||'0',10));
      const p2Qty=Math.max(0,parseInt(el('p2Qty').value||'0',10));

      const p1Pieces = PRICES.p1PiecesPer[pack]*p1Qty;
      el('p1PiecesHint').textContent=`Aktuell: ${p1Pieces} Stück`;

      const p1Subtotal=PRICES.p1[pack]*p1Qty;
      const p2Subtotal=PRICES.p2*p2Qty;
      const total=p1Subtotal+p2Subtotal;

      el('p1Subtotal').value=formatEUR(p1Subtotal);
      el('p2Subtotal').value=formatEUR(p2Subtotal);
      el('grandTotal').textContent=formatEUR(total);

      if(p1Pieces>0){
        el('p1NamesBlock').classList.remove('hidden');
      }else{
        el('p1NamesBlock').classList.add('hidden');
        el('p1Names').value='';
        el('p1NamesError').classList.add('hidden');
      }

      const lines=[];
      if(p1Qty>0){
        const packLabel=pack==='single'?'Einzel':(pack==='pack5'?'5er-Pack':'10er-Pack');
        lines.push(`Produkt 1 (Glas-Tag) – ${packLabel} × ${p1Qty} = ${formatEUR(p1Subtotal)} (= ${p1Pieces} Stück)`);
      }
      if(p2Qty>0) lines.push(`Produkt 2 (Deluxe Kakao) × ${p2Qty} = ${formatEUR(p2Subtotal)}`);

      const coupon = el('coupon').value.trim();
      if(coupon) lines.push(`Gewinncode: ${coupon}`);

      el('cartPreview').textContent = lines.length ? formatLines(lines) : 'Noch keine Artikel.';
    }

    function validate(){
      if(el('hp_field').value) return {ok:false,msg:'Spam erkannt.'};
      const name=el('name').value.trim();
      const phone=el('phone').value.trim();
      const email=el('email').value.trim();
      const pack=el('p1Pack').value;
      const p1Qty=Math.max(0,parseInt(el('p1Qty').value||'0',10));
      const p2Qty=Math.max(0,parseInt(el('p2Qty').value||'0',10));
      const p1Pieces=PRICES.p1PiecesPer[pack]*p1Qty;

      if(!name||!phone||!email) return {ok:false,msg:'Bitte Name, Telefon und E-Mail ausfüllen.'};
      if(p1Qty+p2Qty===0) return {ok:false,msg:'Bitte mindestens ein Produkt auswählen.'};

      if(p1Pieces>0){
        const names=el('p1Names').value.split('\n').map(s=>s.trim()).filter(Boolean);
        if(names.length!==p1Pieces){
          el('p1NamesError').classList.remove('hidden');
          return {ok:false,msg:`Anzahl der Glas-Tag-Namen (${names.length}) passt nicht zur Stückzahl (${p1Pieces}).`};
        } else {
          el('p1NamesError').classList.add('hidden');
        }
      }
      return {ok:true};
    }

    ['p1Pack','p1Qty','p2Qty','coupon'].forEach(id=>el(id).addEventListener('input',recalc));
    recalc();

    /* ===== Absenden ===== */
    document.getElementById('orderForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      el('formError').classList.add('hidden');
      el('formOk').classList.add('hidden');

      const v=validate();
      if(!v.ok){ el('formError').textContent=v.msg; el('formError').classList.remove('hidden'); return; }

      const pack=el('p1Pack').value;
      const p1Qty=Math.max(0,parseInt(el('p1Qty').value||'0',10));
      const p2Qty=Math.max(0,parseInt(el('p2Qty').value||'0',10));
      const p1Pieces=PRICES.p1PiecesPer[pack]*p1Qty;
      const p1SubtotalVal=PRICES.p1[pack]*p1Qty;
      const p2SubtotalVal=PRICES.p2*p2Qty;

      const cartLines=[];
      if(p1Qty>0){
        const packLabel=pack==='single'?'Einzel':(pack==='pack5'?'5er-Pack':'10er-Pack');
        cartLines.push(`Produkt 1 (Glas-Tag) – ${packLabel} × ${p1Qty} = ${formatEUR(p1SubtotalVal)} (= ${p1Pieces} Stück)`);
      }
      if(p2Qty>0) cartLines.push(`Produkt 2 (Deluxe Kakao) × ${p2Qty} = ${formatEUR(p2SubtotalVal)}`);

      const coupon=el('coupon').value.trim();
      if(coupon) cartLines.push(`Gewinncode: ${coupon}`);

      const payload={
        customer_name:  el('name').value.trim(),
        customer_phone: el('phone').value.trim(),
        customer_email: el('email').value.trim(),
        items_text:     cartLines.join(' | '),
        total:          el('grandTotal').textContent,
        p1_names:       el('p1Names').value,
        reply_to:       el('email').value.trim()
      };

      try{
        const result=await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,payload);
        if(result && result.status>=200 && result.status<300){
          el('formOk').classList.remove('hidden');
        } else { throw new Error('EmailJS: Unerwartete Antwort'); }
      }catch(err){
        console.error(err);
        el('formError').textContent='Senden fehlgeschlagen. Prüfe EmailJS Keys/IDs und Template.';
        el('formError').classList.remove('hidden');
      }
    });
  </script>

  <!-- ===== LOKALER TICKER: lädt ./ticker.json (24h Cache, Retry, kein CORS, kein Key) ===== -->
  <script>
    const TICKER_URL = "./ticker.json";
    const CACHE_KEY = "localTickerCache_v1";
    const CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24h
    const TIMEOUT_MS = 8000;
    const MAX_RETRY = 2;

    const euro0 = (n) => new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(n);

    function renderTicker(items, fromCache=false){
      const mk = (it) => {
        const text = it.text || "";
        const url  = it.url;
        const val  = (typeof it.value === "number") ? ` <strong>${euro0(it.value)}</strong>` : "";
        const extra= it.extra ? ` <small>${it.extra}</small>` : "";
        if (url) return `<span class="ticker-item">• <a href="${url}" target="_blank" rel="noreferrer">${text}</a>${val}${extra}</span>`;
        return `<span class="ticker-item">• ${text}${val}${extra}</span>`;
      };
      const html = items.map(mk);
      const track = document.getElementById("tickerTrack");
      if (track) track.innerHTML = html.concat(html).join("") + (fromCache ? `<span class="ticker-item">(Cache)</span>` : "");
    }

    function tryRenderFromCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return false;
        const {ts,items} = JSON.parse(raw);
        if(!Array.isArray(items) || (Date.now()-ts)>CACHE_TTL_MS) return false;
        renderTicker(items,true);
        return true;
      }catch{ return false; }
    }

    async function fetchJSON(url, {timeout=TIMEOUT_MS, retries=MAX_RETRY} = {}){
      let lastErr;
      for(let attempt=0; attempt<=retries; attempt++){
        const ac = new AbortController();
        const timer = setTimeout(()=>ac.abort(new DOMException(`Timeout nach ${timeout}ms`,"TimeoutError")), timeout);
        try{
          const r = await fetch(url, {signal: ac.signal, cache: "no-store"});
          clearTimeout(timer);
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          return await r.json();
        }catch(e){
          clearTimeout(timer);
          lastErr = e;
          if(attempt<retries) await new Promise(res=>setTimeout(res, 400*(attempt+1)));
        }
      }
      throw lastErr;
    }

    async function loadLocalTicker(){
      tryRenderFromCache(); // sofort
      const data = await fetchJSON(TICKER_URL);
      if(!data || !Array.isArray(data.items) || data.items.length===0) throw new Error("Ungültiges ticker.json Format");
      renderTicker(data.items);
      try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), items:data.items})); }catch{}
    }

    (async () => {
      const track = document.getElementById("tickerTrack");
      if (track) track.textContent = "Lade Neuigkeiten …";
      try {
        await loadLocalTicker();
      } catch (err) {
        console.error("Ticker-Fehler:", err);
        if(!tryRenderFromCache()){
          const t = document.getElementById("tickerTrack");
          if (t) {
            const msg = ['⚠️ Ticker-Error', navigator.onLine?'(online)':'(offline)', (err && err.message)?'· '+err.message:''].join(' ');
            t.innerHTML = `
              <span class="ticker-item">${msg}</span>
              <span class="ticker-item">Hinweis: <code>ticker.json</code> fehlt oder ist ungültig.</span>
            `;
          }
        }
      }
      // 24h-Refresh
      setInterval(()=>loadLocalTicker().catch(()=>{}), 24*60*60*1000);
    })();
  </script>
</body>
</html>
